cl_image_upload_tag(:photo_id, :resource_type => :image,
                    :transformation => incoming_transformation)incoming_transformation = [ { width: 1200, height: 1200, crop: 'limit'},
                            { overlay: 'logos_watermark', width: 0.7, 
                              flags: 'relative', opacity: 40, gravity: 'north', y: 20 } ]preloaded = Cloudinary::PreloadedFile.new(params[:photo_id])         
pubnub = Pubnub.new( :publish_key => PUBNUB_PUBLISH_KEY, 
                     :subscribe_key => PUBNUB_SUBSCRIBE_KEY )

pubnub.publish({
    :channel => PUBNUB_CHANNEL,
    :message => {
        cloudinary_photo_id: preloaded.identifier,
        user: params[:user],
        message: params[:message],
        kind: params[:kind],
        time: Time.now.utc.iso8601
    },
    :callback => lambda { |x| $stderr.puts("Shared #{preloaded.public_id}: #{x}") }
})var pubnub = PUBNUB.init({ subscribe_key: PUBNUB_SUBSCRIBE_KEY});
pubnub.subscribe({ channel : PUBNUB_CHANNEL,
                   callback : show_message });function show_message(message) {
  var link = $('<a></a>').
    attr('href', $.cloudinary.url(message.cloudinary_photo_id)).
    append($.cloudinary.image(message.cloudinary_photo_id, 
               { width: 150, height: 100, crop: "fill",
                 gravity: "face", radius: 20, effect: "sepia"});
  $('.stream').prepend($('<li></li>').append(link));
}pubnub.history({
    channel  : PUBNUB_CHANNEL,
    limit    : 5,
    callback : function(history) { $.each(history, function() { show_message(this); })}
});
